<?php
/*
Simple:Press
Google XML Sitemap Plugin Support Routines
$LastChangedDate: 2017-08-05 00:56:34 -0500 (Sat, 05 Aug 2017) $
$Rev: 15487 $
*/

if (preg_match('#'.basename(__FILE__).'#', $_SERVER['PHP_SELF'])) die('Access denied - you cannot directly call this file');


# google xml sitemap support functions
function sp_google_sitemap_do_add_index($data) {
    sp_forum_ajax_support();

   	$last_post = SP()->DB->select('SELECT '.SPTOPICS.'.post_id FROM '.SPTOPICS.' JOIN '.SPFORUMS.' ON '.SPTOPICS.'.forum_id='.SPFORUMS.'.forum_id WHERE in_sitemap=1 ORDER BY '.SPTOPICS.'.post_ID DESC LIMIT 1', 'var');
    $last_post_time = SP()->DB->select('SELECT UNIX_TIMESTAMP(post_date) FROM '.SPPOSTS.' WHERE post_id='.$last_post, 'var');

	$generatorObject = &GoogleSitemapGenerator::GetInstance();
    $generatorObject->AddSitemap('forum', null, $last_post_time);
}

function sp_google_sitemap_do_add_sitemap($data, $type, $params) {
    if ($type == 'forum') sp_google_sitemap_do_build_sitemap();

    return;
}

function sp_google_sitemap_do_build_sitemap() {
    sp_forum_ajax_support();

	$generatorObject = &GoogleSitemapGenerator::GetInstance();
	if ($generatorObject != null) {
    	$topics = SP()->DB->select('SELECT topic_id, '.SPTOPICS.'.forum_id, topic_slug, forum_slug FROM '.SPTOPICS.' JOIN '.SPFORUMS.' ON '.SPTOPICS.'.forum_id='.SPFORUMS.'.forum_id WHERE in_sitemap=1 ORDER BY '.SPTOPICS.'.post_ID DESC');
		if ($topics) {
			foreach ($topics as $topic) {
    			if (!SP()->auths->can_view($topic->forum_id, 'topic-title')) continue;

				$url = SP()->spPermalinks->build_url($topic->forum_slug, $topic->topic_slug, 0, 0);
				$time = SP()->DB->table(SPPOSTS, "topic_id=$topic->topic_id", 'UNIX_TIMESTAMP(post_date) as udate', 'post_id DESC', '1');
    			$count = SP()->DB->table(SPTOPICS, "topic_id=$topic->topic_id", 'post_count');
    			if ($count > 10) {
    				$pri = 0.8;
    			} else if ($count > 5) {
    				$pri = 0.6;
    			} else {
    				$pri = 0.5;
    			}
				$generatorObject->AddUrl($url, $time, 'daily', $pri);
			}
		}
	}
}

# wp seo xml sitemap support functions
function sp_google_sitemap_do_generate_yoast_main() {
    $map = '';

	$base = $GLOBALS['wp_rewrite']->using_index_permalinks() ? 'index.php/' : '';
    $date = SP()->DB->table(SPPOSTS, '', 'UNIX_TIMESTAMP(post_date)', 'post_date DESC', '1');
	$map.= '<sitemap>'."\n";
	$map.= '<loc>'.home_url($base.'forum-sitemap.xml').'</loc>'."\n";
	$map.= '<lastmod>'.date('c', $date).'</lastmod>'."\n";
	$map.= '</sitemap>' . "\n";

    return $map;
}

function sp_google_sitemap_do_generate_yoast_map() {
    sp_forum_ajax_support();

    $map = '';

    $map = '<urlset xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.sitemaps.org/schemas/sitemap/0.9 http://www.sitemaps.org/schemas/sitemap/0.9/sitemap.xsd" xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">'."\n";

	$topics = SP()->DB->select('SELECT topic_id, '.SPTOPICS.'.forum_id, topic_slug, forum_slug FROM '.SPTOPICS.' JOIN '.SPFORUMS.' ON '.SPTOPICS.'.forum_id='.SPFORUMS.'.forum_id WHERE in_sitemap=1 ORDER BY '.SPTOPICS.'.post_ID DESC');
	if ($topics) {
		foreach ($topics as $topic) {
			if (!SP()->auths->can_view($topic->forum_id, 'topic-title')) continue;

			$url = SP()->spPermalinks->build_url($topic->forum_slug, $topic->topic_slug, 0, 0);
			$time = SP()->DB->table(SPPOSTS, "topic_id=$topic->topic_id", 'UNIX_TIMESTAMP(post_date) as udate', 'post_id', '1');
			$count = SP()->DB->table(SPTOPICS, "topic_id=$topic->topic_id", 'post_count');
			if ($count > 10) {
				$pri = 0.8;
			} else if ($count > 5) {
				$pri = 0.6;
			} else {
				$pri = 0.4;
			}

    		$map.= "\t<url>\n";
    		$map.= "\t\t<loc>".$url."</loc>\n";
    		$map.= "\t\t<lastmod>".date('c', $time)."</lastmod>\n";
    		$map.= "\t\t<changefreq>Daily</changefreq>\n";
    		$map.= "\t\t<priority>".str_replace(',', '.', $pri)."</priority>\n";
    		$map.= "\t</url>\n";
		}
	}

	$map.= '</urlset>';

	header('HTTP/1.1 200 OK', true, 200);

	# Prevent the search engines from indexing the XML Sitemap.
	header('X-Robots-Tag: noindex, follow', true);
	header('Content-Type: text/xml');
	echo '<?xml version="1.0" encoding="'.get_bloginfo('charset').'"?>';
	$stylesheet = '<?xml-stylesheet type="text/xsl" href="' . home_url( 'main-sitemap.xsl' ).'"?>';
	echo apply_filters('wpseo_stylesheet_url', $stylesheet)."\n";
	echo $map;
	echo "\n".'<!-- XML Sitemap generated by Simple:Press -->';

    die();
}

# all in one seo sitemap support functions
function sp_google_sitemap_do_generate_aioseo_slug($extra) {
    $extra[] = 'forum';
    return $extra;
}

function sp_google_sitemap_do_generate_aioseo_index($map, $type, $page, $options) {
    if ($type == 'root') {
        $map[] = array('loc' => site_url($options['aiosp_sitemap_filename'].'_forum.xml'), 'lastmod' => '', 'changefreq' => 'daily', 'priority' => '0.8');
    }

    return $map;
}

function sp_google_sitemap_do_generate_aioseo_map($map) {
    sp_forum_ajax_support();

    $map = array();

	$topics = SP()->DB->select('SELECT topic_id, '.SPTOPICS.'.forum_id, topic_slug, forum_slug FROM '.SPTOPICS.' JOIN '.SPFORUMS.' ON '.SPTOPICS.'.forum_id='.SPFORUMS.'.forum_id WHERE in_sitemap=1 ORDER BY '.SPTOPICS.'.post_ID DESC');
	if ($topics) {
		foreach ($topics as $topic) {
			if (!SP()->auths->can_view($topic->forum_id, 'topic-title')) continue;

			$url = SP()->spPermalinks->build_url($topic->forum_slug, $topic->topic_slug, 0, 0);
			$time = SP()->DB->table(SPPOSTS, "topic_id=$topic->topic_id", 'UNIX_TIMESTAMP(post_date) as udate', 'post_id DESC', '1');
			$count = SP()->DB->table(SPTOPICS, "topic_id=$topic->topic_id", 'post_count');
			if ($count > 10) {
				$pri = 0.8;
			} else if ($count > 5) {
				$pri = 0.6;
			} else {
				$pri = 0.5;
			}
			$map[] = array('loc' => $url, 'lastmod' => date('c', $time), 'changefreq' => 'daily', 'priority' => $pri);
		}
	}

    return $map;
}
