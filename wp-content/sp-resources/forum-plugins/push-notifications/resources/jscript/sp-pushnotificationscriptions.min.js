/* ---------------------------------
Simple:Press
Push Notifications Plugin Javascript
------------------------------------ */
"use strict";
var App = function() {

    function subscribeTopic(url, target, uicon, sicon, ulabel, slabel, utooltip, stooltip) {
        
        jQuery.ajax({
            type: 'GET',
            url: url,
            cache: false,
            success: function (html) {
                jQuery('#' + target).html(function (i, t) {
                    var old = new RegExp(sicon, 'g');
                    return t.replace(old, uicon);
                });
                jQuery('[data-target='+target+']').attr('title', utooltip);
                jQuery('[data-target='+target+'] span').html(ulabel);
                jQuery('[data-target='+target+']').removeClass('spPushNotificationsSubscribe');
                jQuery('[data-target='+target+']').addClass('spPushNotificationsUnsubscribe');
                jQuery('[data-target='+target+']').attr('data-url', this.url.replace(/add-sub/, 'del-sub'));
                jQuery('[data-target='+target+']').data('url', jQuery('[data-target='+target+']').attr('data-url'));
                spj.displayNotification(0, sp_subs_vars.addsubtopic);
            }
        });

    }

    function unsubscribeTopic(url, target, uicon, sicon, ulabel, slabel, utooltip, stooltip) {
        jQuery.ajax({
            type: 'GET',
            url: url,
            cache: false,
            success: function (html) {
                jQuery('[data-target='+target+']').html(function (i, t) {
                    var old = new RegExp(uicon, 'g');
                    return t.replace(old, sicon);
                });
                jQuery('[data-target='+target+']').attr('title', stooltip);
                jQuery('[data-target='+target+']' + ' span').html(slabel);
                jQuery('[data-target='+target+']').removeClass('spPushNotificationsUnsubscribe');
                jQuery('[data-target='+target+']').addClass('spPushNotificationsSubscribe');
                jQuery('[data-target='+target+']').attr('data-url', this.url.replace(/del-sub/, 'add-sub'));
                jQuery('[data-target='+target+']').data('url', jQuery('[data-target='+target+']').attr('data-url'));
                spj.displayNotification(0, sp_subs_vars.delsubtopic);
            }
        });

    }

	/***********************************************
	 event handlers
	***********************************************/

    let sppush_show_subs_popup = {
        init: function () {
            jQuery('.spPushNotificationsShowTopicSubs').click(function () {
                var mydata = jQuery(this).data();
                spj.dialogAjax(this, mydata.site, mydata.label, mydata.width, mydata.height, mydata.align);
                jQuery('#dialog, #spMobilePanel').one('opened', function () {
                    sppush_end_subscription.init();
                });
            });
        }
    };

    let sppush_end_subscription = {
        init: function () {
            jQuery('.spPushNotificationsEndButton').click(function () {
                var mydata = jQuery(this).data();
                jQuery('#' + mydata.target).load(mydata.site);
                jQuery('#' + mydata.target).fadeOut(2000, function () {
                    var prev = jQuery('#' + mydata.target).prevAll(":visible:first");
                    var next = jQuery('#' + mydata.target).nextAll(":visible:first");
                    if (prev.is('a') && !next.is('div')) {
                        prev.fadeOut(100);
                        var list = jQuery('#spMainContainer > .spListSection > a').nextAll(":visible:first");
                        if (list.length == 0) {
                            jQuery('#spMainContainer > .spUnsubscribeAll').html('');
                            jQuery('#spMainContainer > .spListSection').html('<div class="spMessage"><p>' + sp_subs_vars.nosubs + '</p></div>');
                        }
                    }
                });
            });
        }
    };

    let sppush_subscribe = {
        init: function () {
            jQuery(document).on('click', '.spPushNotificationsSubscribe',function(){        
                var mydata = jQuery(this).data();
                subscribeTopic(mydata.url, mydata.target, mydata.unsubicon, mydata.subicon, mydata.unsublabel, mydata.sublabel, mydata.unsubtip, mydata.subtip);
            });
        }
    };

    let sppush_unsubscribe = {
        init: function () {
            jQuery(document).on('click', '.spPushNotificationsUnsubscribe',function(){
                var mydata = jQuery(this).data();
                unsubscribeTopic(mydata.url, mydata.target, mydata.unsubicon, mydata.subicon, mydata.unsublabel, mydata.sublabel, mydata.unsubtip, mydata.subtip);
            })
        }
    };

    let onesignal = {
        init: function () {


            OneSignal.push(function() {
                var mydata = {};
                OneSignal.getUserId(function(userId) {
                    mydata.onesignal = userId; 
                });
                OneSignal.on('subscriptionChange', function (isSubscribed) {

                    jQuery.ajax({
                        type: 'GET',
                        url: '/wp-admin/admin-ajax.php',
                        cache: false,
                        data: {
                            action : 'update_keys',
                            device_id : mydata.onesignal,
                            sub_action : isSubscribed ? 'add' : 'remove'
                        }
                    })

                })
            })


        }
    }
    
    return {
        init: function() {
            sppush_show_subs_popup.init();
            sppush_subscribe.init();
            sppush_unsubscribe.init();
            onesignal.init();
        }
    }

}();

jQuery(document).ready(function() {
    App.init();
});